/* jshint camelcase: false */
/* globals themeCheckout, STRIPE_PUBLIC_KEY, BOOKING_FEE, Raven */

(function ( $ ) {
	'use strict';

	window.themeCheckout = {
		init: function () {
			themeCheckout.initProps();
			themeCheckout.attachEvents();
		},
		initProps: function () {
			themeCheckout.$quantitySelect = $( '.ticket-quantity select' );
			themeCheckout.$checkout = $( '#checkout' );
			themeCheckout.$checkoutContainer = themeCheckout.$checkout.find( '.checkout-container' );
			themeCheckout.$form = $( '#payment-details' );
			themeCheckout.order = {
				showtime: $( '#sid' ).val(),
				tickets: {},
				total: 0,
				bookingFee: 0,
				discount: 0,
				donation: 0
			};

			// checkout form
			themeCheckout.paymentMethod = 'cc';
			themeCheckout.$fields = $( '.payment-address' ).find( 'input[type=text], input[type=email]' ).not( '#discount-code' );
			themeCheckout.$ccFields = $( '.payment-info' );
			themeCheckout.$emailInput = $( '#email' );
			themeCheckout.$gcInput = $( '#gc' );
			themeCheckout.$gcCvvInput = $( '#gc-cvv' );
			themeCheckout.$terms = $( '.terms' );
			themeCheckout.$submitButton = $( '#submit-purchase' );
			themeCheckout.$submitError = $( '.submit-error' );
			themeCheckout.$orderConfirmation = $( '#order-confirmation' );
			themeCheckout.$inactiveForm = $( '.checkout-container' ).not( '.checkout-active' ).find( themeCheckout.$form );
			themeCheckout.$donationAmount = $( '.donation-form input' );
			themeCheckout.$donateAmount = $( '#donate-me' );

			// Gift Cards.
			themeCheckout.$giftCardWrap = $( document.getElementById( 'gc-wrap' ) );
			themeCheckout.$giftCard = $( document.getElementById( 'gc' ) );
			themeCheckout.$giftCardCvv = $( document.getElementById( 'gc-cvv' ) );
			themeCheckout.$giftCardApply = $( document.getElementById( 'apply-gc' ) );
			themeCheckout.$giftCardError = $( document.getElementById( 'gc-error-message' ) );
			themeCheckout.$giftCardTotal = $( '.gift-card' );
			themeCheckout.$giftCardRow = $( '.gift-card-row' );

			// discount codes
			themeCheckout.$discountCode = $( '#discount-code' );
			themeCheckout.$discountCodeApply = $( '#apply-discount-code' );
			themeCheckout.$discountCodeError = $( '#discount-code-error-message' );
			themeCheckout.$discount = $( '.discount' );

			// memberships
			themeCheckout.$membershipSignup = $( '.membership-signup' );
			themeCheckout.$membershipPlan = $( '.membership-plan-type [type="radio"]' );
			themeCheckout.$membershipCost = $( '.membership_type_value' ).data( 'json' );

			// ticket packs
			themeCheckout.$ticketPackPurchase = $( '.ticket-pack-purchase' );
			themeCheckout.$ticketPackValue = $( '.ticket-pack-value' ).data( 'json' );

			// dnd
			themeCheckout.$dnd = $( '#dnd' );
			themeCheckout.$dndCheckbox = themeCheckout.$dnd.find( 'input[type=checkbox]' );
			themeCheckout.$dndStep2 = $( '#dnd-step-2' );
			themeCheckout.$phone = $( '#phone' );
			themeCheckout.$phone.prop( 'disabled', true );
			themeCheckout.$tipOptions = $( '#tip-options' );
			themeCheckout.$tipPercent = $( '#tip-percent' );

			// reserved seating
			themeCheckout.$overlayMessage = $( '.overlay-message' );
			themeCheckout.$reservedOrderId = null;
			themeCheckout.$seatsData = {};
			themeCheckout.$selectedSeats = [];
			themeCheckout.$reservedSeats = [];
			themeCheckout.$hall = null;
			themeCheckout.$inRequest = false;
			themeCheckout.$seatsModal = $( '.seats-modal' );
			themeCheckout.$checkoutSeatsModal = $( '.seats-modal-checkout' );
			themeCheckout.$cancelSeatsModal = $( '.seats-modal-cancel' );
			themeCheckout.$openSeatsModal = $( '.open-seats-modal' );
			themeCheckout.$rsShowtimePicker = $( '.rs-select-showtime-container' );
			themeCheckout.$rsSelectedShowtime = $( '.rs-selected-showtime' );
			themeCheckout.seatPropertiesCache = {};
			themeCheckout.refreshableProps();
			themeCheckout.seatsADAList = $( '#selector-seats' );
			themeCheckout.$sidebar = $( '#sidebar' );
			themeCheckout.$siteHeader = $( '#site-header, #mobile-nav' );
			themeCheckout.$siteFooter = $( '#footer-container, #footer-nav' );
			themeCheckout.seatsADAListOption = $( '#selector-seats option' );
			themeCheckout.ADAModeOn = $( '.accessibility-mode-on' );
			themeCheckout.ADAModeOff = $( '.accessibility-mode-off' );
			themeCheckout.$shortSeatsList = [];

			themeCheckout.ADAContainer = $( '.ada-container' );
			themeCheckout.ADAMode = false;
			themeCheckout.seatmapContainer = $( '.hall-container' );
			themeCheckout.lastValidSelection = null;
			themeCheckout.selectedADASeat = [];

			// themeCheckout.$inactiveForm = $( '.checkout-container' ).not( '.checkout-active' ).find( themeCheckout.$form );
			themeCheckout.$isMobile = window.matchMedia( 'only screen and (max-width: 667px)' );
			themeCheckout.$isTablet = window.matchMedia( 'only screen and (max-width: 1024px)' );

			// prevent double submits
			themeCheckout.checkoutSubmitted = false;
		},
		refreshableProps: function () {
			themeCheckout.$seatTicketTypeSelect = $( '.seat-ticket-type .select-ticket-type' ).not( '.hidden' ).find( 'select' );
		},
		attachEvents: function () {
			// update page on select ticket quantity
			themeCheckout.$quantitySelect.change( function () {
				themeCheckout.toggleActiveCheckout();
				themeCheckout.manageQtysAvailable();
				themeCheckout.applyDiscountCode();
			} );

			// initialize hosted token form
			if ( typeof STRIPE_PUBLIC_KEY !== 'undefined' && !!STRIPE_PUBLIC_KEY ) {
				themeUx.$window.on( 'load', themeCheckout.initStripeElements );
			}

			// validate checkout form on submit
			themeCheckout.$form.submit( function ( e ) {
				themeCheckout.disableForm();
				if ( !themeCheckout.validateForm( e ) ) {
					themeCheckout.enableForm();
				}
			} );

			// validate terms checkbox
			if ( themeCheckout.$terms.length ) {
				$( 'input[name=terms]' ).click( function () {
					themeCheckout.validateTermsCheckbox();
				} );
			}

			// validate gc number (not empty)
			themeCheckout.$gcInput.blur( function () {
				if ( themeCheckout.paymentMethod === 'gc' || themeCheckout.paymentMethod === 'gc_partial' ) {
					themeCheckout.validateInputs( $( this ) );
				}
			} );

			// validate gc cvv (not empty)
			themeCheckout.$gcCvvInput.blur( function () {
				if ( themeCheckout.paymentMethod === 'gc' || themeCheckout.paymentMethod === 'gc_partial' ) {
					themeCheckout.validateInputs( $( this ) );
				}
			} );

			// validate text fields (not empty)
			themeCheckout.$fields.blur( function () {
				themeCheckout.validateInputs( $( this ) );
			} );

			// validate email fields (valid email)
			themeCheckout.$emailInput.blur( function () {
				themeCheckout.checkEmailInput();
			} );

			// show zero quantity selected error
			themeCheckout.$inactiveForm.click( function () {
				if ( !$( '.checkout-active' ).length ) {
					$( '.ticket-quantity' ).addClass( 'no-quantity' );
					themeCheckout.scrollUp();
				}
			} );

			// validate donation amount
			themeCheckout.$donationAmount.on( 'change', function () {
				var $this = $( this );
				var rawDonationAmount = parseFloat( $this.val() );
				var donationAmount = rawDonationAmount.toFixed( 2 );

				// Set the donation amount in the UI and on the themeCheckout.order object.
				$this.val( donationAmount );
				$( '.total_purchase_price' ).text( donationAmount );

				themeCheckout.order.donation = donationAmount;

				themeCheckout.maybeReapplyGiftCard();
			} );

			// include donation in checkout
			themeCheckout.$donateAmount.on( 'click', function () {
				$( '.donate' ).slideToggle( '200' );

				if ( $( '.seat-ticket-type' ).length > 0 ) {
					themeCheckout.updateQuantityBySeats();
				} else {
					themeCheckout.updateQuantity();
				}

				themeCheckout.maybeReapplyGiftCard();
			} );

			// update membership plan cost
			themeCheckout.$membershipPlan.on( 'change', function () {
				var $this = $( this ),
					planType = $this.val();

				themeCheckout.order.membership = parseFloat( themeCheckout.$membershipCost[ 'annual' ][ planType ] );
				themeCheckout.order.membership_plan.selected = planType;
				themeCheckout.order.total = themeCheckout.order.membership;
			} );

			// Set up membership plan cost details on Membership Renewal page.
			$( window ).on( 'load', function() {
				if ( $( 'body' ).is( '.membership-renew' ) ) {

					// On the renewal page, planType is added to the membership cost JSON directly.
					const planType = themeCheckout.$membershipCost.planType;

					themeCheckout.order.membership = parseFloat( themeCheckout.$membershipCost[ 'annual' ][ planType ] );

					themeCheckout.order.membership_renewal_id = document.getElementById( 'membership-renewal-id' ).value;

					themeCheckout.order.membership_plan = {
						'title': themeCheckout.$membershipCost[ 'plan' ],
						'id': themeCheckout.$membershipCost[ 'id' ],
						'selected': planType,
					};

					themeCheckout.order.total = themeCheckout.order.membership;

					$( '.total_purchase_price' ).text( themeCheckout.order.total.toFixed( 2 ) );
				}
			} );

			// update payment method
			$( '.payment-type a' ).on( 'click', function () {
				themeCheckout.paymentMethod = $( this ).data( 'pmethod' );
				themeCheckout.$form.find( '*' ).removeClass( 'error' );
				if ( themeCheckout.paymentMethod === 'gc' ) {
					themeCheckout.$dnd.slideUp();
					themeCheckout.$dndCheckbox.prop( 'checked', false );
				} else {
					themeCheckout.$dnd.slideDown();
				}
			} );

			// Apply gift card.
			themeCheckout.$giftCardApply.on( 'click', function( event ) {
				event.preventDefault();

				themeCheckout.$giftCardError.html( '' ).css( 'visibility', 'hidden' );

				if ( true === themeCheckout.$giftCard.prop( 'readonly' ) && 'REMOVE' === themeCheckout.$giftCardApply.html() ) {
					themeCheckout.removeGiftCard();
					return false;
				}

				themeCheckout.applyGiftCard();
			} );

			// apply discount code
			themeCheckout.$discountCodeApply.on( 'click', function ( e ) {
				e.preventDefault();
				themeCheckout.$discountCodeError.html( '' ).css( 'visibility', 'hidden' );
				if ( themeCheckout.$discountCode.prop( 'readonly' ) === true && themeCheckout.$discountCodeApply.html() === 'REMOVE' ) {
					themeCheckout.removeDiscountCode();
					return false;
				}
				themeCheckout.applyDiscountCode();
			} );

			// dnd
			themeCheckout.$dndCheckbox.on( 'click', function ( e ) {
				if ( $( this ).is( ':checked' ) ) {
					themeCheckout.$dndStep2.show();
					// order ahead / phone
					// themeCheckout.$phone.prop( 'disabled', false );
					// themeCheckout.$phone.on( 'blur', function () {
					// 	themeCheckout.validatePhoneNumber( $( this ) );
					// } );

					// pre-set tip
					themeCheckout.$tipPercent.prop( 'disabled', false );
					themeCheckout.$tipPercent.on( 'blur', function () {
						themeCheckout.validateTipPercent( $( this ) );
					} );
					themeCheckout.$fields = themeCheckout.$fields.add( themeCheckout.$tipPercent );
					if ( themeCheckout.$tipPercent.val() === "" ) {
						themeCheckout.$tipOptions.find( "li:nth-child(2) a" ).trigger( 'click' ).focus();
					}
				} else {
					themeCheckout.$dndStep2.hide();

					// order ahead / phone
					// themeCheckout.$phone.prop( 'disabled', true );
					// themeCheckout.$phone.off( 'blur' );
					// themeCheckout.$phone.removeClass( 'error' );

					// pre-set tip
					themeCheckout.$tipPercent.prop( 'disabled', true );
					themeCheckout.$tipPercent.off( 'blur' );
					themeCheckout.$tipPercent.removeClass( 'error' );
					themeCheckout.$fields = themeCheckout.$fields.not( themeCheckout.$tipPercent );
				}
			} );

			$( '.dnd-explainer' ).on( 'click', function ( e ) {
				e.preventDefault();
				var $modal = $( '.dnd-explainer-modal' );
				$modal.addClass( 'active' );
			} );

			$( '.dnd-explainer-modal .modal-backdrop, .dnd-explainer-modal .close-modal' ).on( 'click', function () {
				$( '.modal.active' ).removeClass( 'active' );
			} );

			themeCheckout.$tipOptions.find( 'a' ).on( 'click', function ( e ) {
				e.preventDefault();
				var percent = $( this ).data( 'tip_percent' );
				themeCheckout.$tipPercent.val( percent );
			} );

			// reserved seating

			// fetch seats data from auditorium
			if ( themeCheckout.order.showtime ) {
				themeCheckout.getSeatsData();
			}

			// handle Checkout from Seats Modal
			themeCheckout.$checkoutSeatsModal.click( function () {
				themeCheckout.clearErrors();
				themeCheckout.reserveSeats();
			} );

			// handle Cancel from Seats Modal
			themeCheckout.$cancelSeatsModal.on( 'click', themeCheckout.hideSeatsModal );
			themeCheckout.$openSeatsModal.on( 'click', themeCheckout.getSeatsData );

			// handle Change seat ticket type
			themeCheckout.$seatTicketTypeSelect.change( themeCheckout.changeReservedSeatTicketType );

			// handle change showtimes
			themeCheckout.$rsShowtimePicker.find( 'select' ).on( 'change', function () {
				window.location = $( this ).val();
			} );

			// show ADA
			themeCheckout.ADAModeOn.click( function () {
				themeCheckout.ADAContainer.show();
				themeCheckout.seatmapContainer.hide();
				themeCheckout.ADAMode = true;
				themeCheckout.ADAModeOn.hide();
				themeCheckout.$siteHeader.hide();
				themeCheckout.$siteFooter.css( 'display', 'none !important' );
				$( 'button.seats-modal-checkout' ).hide();
			});

			// hide ADA
			themeCheckout.ADAModeOff.click( function () {
				themeCheckout.ADAContainer.hide();
				themeCheckout.seatmapContainer.show();
				themeCheckout.ADAMode = false;
				themeCheckout.seatsADAList.val( '' );
				themeCheckout.$checkoutSeatsModal.text( 'Checkout' );
				themeCheckout.ADAModeOn.show();
				themeCheckout.$siteHeader.show();
				themeCheckout.$siteFooter.css( 'display', 'flex' );
				$( 'button.seats-modal-checkout' ).show();
				themeCheckout.showSeatsModal();
			});

			// handle choose seats from ADA selector
			themeCheckout.seatsADAList.change( function () {
				themeCheckout.selectedADASeat = [];
				themeCheckout.selectedADASeatName = [];
				themeCheckout.confirmADA = '';
				var selectOptionQt = 0;
				if ( themeCheckout.seatsADAList.val() ) {
					selectOptionQt = themeCheckout.seatsADAList.val().length;
				}

				if ( selectOptionQt > 6) {
					themeCheckout.seatsADAList.val( themeCheckout.lastValidSelection );
					themeCheckout.$submitError.attr( {
						role: 'alert',
						tabindex: -1
					} ).text( 'You cannot select more than 6 seats.' );
					themeCheckout.selectedADASeat = themeCheckout.lastValidSelection;
				} else {
					$.each( $( themeCheckout.seatsADAList ).find( ":selected" ), function () {
						themeCheckout.selectedADASeat.push( $( this ).val() );
						themeCheckout.selectedADASeatName.push( $( this ).data( 'name-seat' ) );
						themeCheckout.$checkoutSeatsModal.text( "Reserve Seats:" + themeCheckout.selectedADASeatName );
						themeCheckout.clearErrors();
					});
					themeCheckout.lastValidSelection = $( this ).val();
					themeCheckout.clearErrors();
				}

				if ( selectOptionQt > 0  ) {
					$( 'button.seats-modal-checkout' ).show();
				} else {
					$( 'button.seats-modal-checkout' ).hide();
					themeCheckout.$checkoutSeatsModal.text( 'Checkout' );
				}
			});

			// submit reserve seats if pressed enter key in seatslist
			$( document ).keypress(  function( e ) {
				if ( e.which === 13 && themeCheckout.seatsADAList.val() && themeCheckout.seatsADAList.is(':focus') ) {
					themeCheckout.$checkoutSeatsModal.click();
				}
			});

			// Some simple AJAX loading-state functionality to help prevent form submissions while things are still loading.
			themeCheckout.$checkout.on( 'checkout-start-loading', function() {
				themeCheckout.$checkout.addClass( 'checkout--is-loading' );
			} );

			themeCheckout.$checkout.on( 'checkout-stop-loading', function() {
				themeCheckout.$checkout.removeClass( 'checkout--is-loading' );
			} );
		},
		clearErrors: function () {
			themeCheckout.$submitError.attr( {
				role: '',
				tabindex: ''
			} ).text( '' );
		},
		hideSeatsModal: function () {
			themeCheckout.clearErrors();
			themeCheckout.$checkout.show();
			themeCheckout.$sidebar.attr( {
				'aria-hidden': false,
				'role': 'banner'
			}).show();
			themeCheckout.$siteFooter.attr( {
				'aria-hidden': false
			}).show();
			themeCheckout.$siteHeader.attr( {
				'aria-hidden': false,
				'role': 'banner'
			});
			themeCheckout.$seatsModal.hide();
			$( "html, body" ).removeClass( 'lock-scroll' ).animate( { scrollTop: 0 }, "fast" );
			$( '#primary-nav' ).attr( 'role', 'navigation' ).show();
		},
		showSeatsModal: function () {
			themeCheckout.$overlayMessage.hide();
			themeCheckout.$seatsModal.show();
			themeCheckout.$checkout.hide();
			themeCheckout.$sidebar.attr( {
				'aria-hidden': true,
				'role': ''
			});
			themeCheckout.$siteFooter.attr( {
				'aria-hidden': true,
				'role': ''
			}).hide();
			themeCheckout.$siteHeader.attr( {
				'aria-hidden': true,
				'role': ''
			});
			// hide menu if not mobile and tablet
			if ( !themeCheckout.$isTablet.matches ) {
				themeCheckout.$sidebar.hide();
				themeCheckout.$siteHeader.hide();
			}
			$( "html, body" ).addClass( 'lock-scroll' );
			$( '#primary-nav' ).attr( 'role', '' ).hide();
		},
		seatClickHandler: function ( items ) {
			themeCheckout.$selectedSeats = items;
			themeCheckout.changeTextCheckoutButton( items );
			if ( items.length === 6 ) {
				themeCheckout.$submitError.text( 'You cannot select more than 6 seats.' );
			} else {
				themeCheckout.clearErrors();
			}
		},
		initializeSeatsView: function ( seatsData ) {
			themeCheckout.$seatsData = seatsData;

			themeCheckout.showSeatsModal();

			// destroy if to re-render
			if ( themeCheckout.$hall ) {
				themeCheckout.$hall.destroy();
				$( '.hall-container' ).html( '<div class="hall-wrapper"><canvas id="hall"></canvas></div>' );
			}

			// initialize seats map component
			if ( themeCheckout.$seatsData && !jQuery.isEmptyObject( themeCheckout.$seatsData ) ) {

				// A hack to show reserved seats instead of selected ones
				var selectedSeats = themeCheckout.$reservedSeats.length ? themeCheckout.$reservedSeats : themeCheckout.$selectedSeats;
				themeCheckout.$hall = new FilmbotHall( themeCheckout.$seatsData, selectedSeats, {
					onSelect: themeCheckout.seatClickHandler,
					onDeselect: themeCheckout.seatClickHandler,
					selectionLimit: 6,
					canvasWidth: 800,
					canvasHeight: 300,
					canvasBg: themeSettings.theme_mods.rs_seatmap_background_color,
					stroke: themeSettings.theme_mods.rs_seat_color,
					fill: themeSettings.theme_mods.rs_seat_color,
					disabledColor: themeSettings.theme_mods.rs_seat_unavailable_color,
					selector: 'hall'
				}, themeCheckout.$reservedSeats );
				themeCheckout.$hall.render();
			}
			themeCheckout.getShortSeatMapList();
		},
		initializeSeatsADAList: function ( seatsData ) {
			themeCheckout.$seatsData = seatsData;

			// render select form for ADA
			$.each( seatsData.sections, function ( index, section ) {
				var legendSeats = seatsData.legend;
				function getTitleSeat ( seat_type ) {
					try {
						return legendSeats.find( seatType => seatType.seat_type === seat_type ).title;
					} catch ( error ) {
						return 'Standard'; // default value
					}
				}
				if ( section ) {
					$.each( section.rows, function ( index, rows ) {
						if ( rows ) {
							$.each( rows.seats, function ( index, seatsList ) {
								if ( seatsList[ 'seat_type' ] !== 'no-seat' ) {
									var availabilitySeat = seatsList[ 'data' ][ 'available' ],
										availabilityAttribute = '',
										seatName = seatsList[ 'display_id' ],
										seatType = seatsList[ 'seat_type' ],
										seatTypeTitle = getTitleSeat( seatType ),
										seatExtra = '',
										confirm_ada_description = '',
										seatAddress = seatsList[ 'seat_address' ],
										seatNameAttribute = 'data-name-seat=" ' + seatName + '"';

									if ( typeof availabilitySeat === 'undefined' ) {
										availabilitySeat = '';
									} else {
										availabilitySeat = ' - Reserved';
										availabilityAttribute = ' disabled="true" ';
									}
									if ( seatsList[ 'confirm_message' ] ) {
										confirm_ada_description = '. ' + seatsList[ 'confirm_message' ];
									}
									if ( seatsList[ 'extra' ] ) {
										seatExtra += ' - ' + seatsList[ 'extra' ];
									}
									var optionContent = 'Seat ' + seatName + ': ' + seatTypeTitle + seatExtra + availabilitySeat + confirm_ada_description;
									themeCheckout.seatsADAList.append( '<option ' +
										'role="option" ' +
										seatNameAttribute +
										'aria-label="' + optionContent + '" ' +
										availabilityAttribute +
										'value="'+ seatAddress + '">' + optionContent + '</option>' );
								}
							});
						}
					});
				}
			});
		},
		timerInterval: false,
		startTimer: function () {
			var duration = 60 * 5, // hard-code 5 min timer
				suffix = ' minutes',
				displayWrapper = $( '.reservation-countdown-message' ),
				display = $( '.reservation-countdown' ),
				start = Date.now(),
				diff,
				minutes,
				seconds;

			displayWrapper.show();

			function timer () {
				// get the number of seconds that have elapsed since
				// startTimer() was called
				diff = duration - (((Date.now() - start) / 1000) | 0);

				if ( diff <= 0 ) {
					themeCheckout.stopTimer();
					if ( !themeCheckout.checkoutSubmitted ) {
						themeCheckout.$overlayMessage.empty().append( '<h3>Sorry!</h3>' );
						themeCheckout.$overlayMessage.append( '<p>Your reservation for ' + $( '.showtime-date' ).text() + ' has expired.</p>' );
						themeCheckout.$overlayMessage.show();
						$( 'html,body' ).css( { overflow: "hidden" } )
						themeCheckout.hideSeatsModal();
					}
				}

				if ( diff < 60 ) {
					suffix = ' seconds';
				}

				// does the same job as parseInt truncates the float
				minutes = (diff / 60) | 0;
				seconds = (diff % 60) | 0;

				minutes = minutes < 10 ? "0" + minutes : minutes;
				seconds = seconds < 10 ? "0" + seconds : seconds;

				display.text( minutes + ":" + seconds + suffix );
			}

			// we don't want to wait a full second before the timer starts
			timer();
			themeCheckout.timerInterval = setInterval( timer, 1000 );
		},
		stopTimer: function () {
			clearInterval( themeCheckout.timerInterval );
		},
		getSeatsData: function () {
			var data = {
				action: 'nj_get_auditorium_seats',
				_ajax_nonce: $( '#nj_checkout_nonce' ).val(),
				showtime_id: themeCheckout.order.showtime
			};

			var seatMapsFetched = $.when( $.ajax(
				{
					url: window.ajaxurl || window.themeSettings.ajaxUrl,
					method: 'POST',
					timeout: 60000,
					data: data,
					success: function ( response ) {
						if ( !!response.sections ) {
							themeCheckout.initializeSeatsView( response );
							themeCheckout.initializeSeatsADAList( response );
							console.info( '[ Fetch seats success ] ', response );
						}
					},
					error: function ( xhr, status, error ) {
						themeCheckout.$submitError.attr( 'role', 'alert' ).text( 'An error occurred, please wait a few minutes and refresh the page.' ).focus();
						console.error( xhr, status, error );
						if ( typeof Raven !== 'undefined' ) {
							Raven.captureMessage( '[ Fetch seats error ] ' + error, {
								level: 'error',
								extra: {
									xhr: xhr,
									status: status
								}
							} );
						}
					}
				}
			) );

			seatMapsFetched.then( function() {
				if (
					'undefined' === typeof window.themeSettings.reservedSeating ||
					'string' !== typeof window.themeSettings.reservedSeating.socialDistancing.infoMsg ) {
					return;
				}

				// A flag for ensuring this info message only displays once, not on each seat map rendering.
				if ( 'true' === window.themeSettings.reservedSeating.socialDistancing.infoMsgAccepted ) {
					return;
				}

				Swal.fire(
					{
						text: window.themeSettings.reservedSeating.socialDistancing.infoMsg,
						showCancelButton: false,
						confirmButtonText: "Continue",
						confirmButtonColor: ""
					}
				).then( (result) => {
					// On "accepting" the info message (closing it), set this flag to prevent the message showing again.
					window.themeSettings.reservedSeating.socialDistancing.infoMsgAccepted = 'true';
				} );
			} );
		},
		reserveSeats: function () {
			if ( themeCheckout.$inRequest ) return;

			if ( !themeCheckout.$selectedSeats.length && !themeCheckout.ADAMode ) {
				themeCheckout.$submitError.attr( 'role', 'alert' ).text( ' Please select seats.' );
				themeCheckout.getSeatsData();
				return false;
			}

			var seats = [];
			var containerSelectedSeats = themeCheckout.$selectedSeats;
			if ( themeCheckout.ADAMode ) {
				containerSelectedSeats = themeCheckout.selectedADASeat;
				themeCheckout.ADAModeOff.hide();
			}
			themeCheckout.ADAModeOn.hide();
			$.each( containerSelectedSeats, function ( index, seat ) {
				seats.push( { "seat": seat } );
			} );

			var donateAmount = 0;
			if ( $( '.donate-amount' ).length ) {
				donateAmount = $( '.donate-amount' ).first().text();
			}
			if ( $( '#donate-me' ).is( ':checked' ) ) {
				themeCheckout.order.donation = donateAmount;
			}

			var data = {
				action: 'nj_reserve_seats',
				_ajax_nonce: $( '#nj_checkout_nonce' ).val(),
				reservations: [
					{
						"showtime_id": themeCheckout.order.showtime,
						"requested_tickets": seats
					}
				]
			};

			if ( themeCheckout.$reservedOrderId ) {
				data[ 'action' ] = 'nj_change_reserved_seats';
				data[ 'order_id' ] = themeCheckout.$reservedOrderId;
			}

			themeCheckout.$inRequest = true;
			themeCheckout.$checkoutSeatsModal.attr( 'disabled', 'disabled' ).html( 'Reserving seats...' );

			$.ajax( {
				url: window.ajaxurl || window.themeSettings.ajaxUrl,
				method: 'POST',
				timeout: 60000,
				data: data,
				success: function ( response ) {
					if ( response.success === false ) {
						console.error( '[ Reserve seats error ]', response.data );
						themeCheckout.$submitError.attr( {
							role: 'alert',
							tabindex: -1
						} ).text( response.data[ 0 ] );
						themeCheckout.getSeatsData();
						themeCheckout.$checkout.show();
						return false;
					}

					if ( !themeCheckout.$reservedOrderId ) themeCheckout.startTimer();
					themeCheckout.$reservedOrderId = response.order_id;

					// hide showtime picker, just show showtime
					themeCheckout.$rsShowtimePicker.hide();
					themeCheckout.$rsSelectedShowtime.show();

					if ( response.errors.length ) {
						console.error( '[ Reserve seats error ]', response.errors );
						themeCheckout.$submitError.attr( {
							role: 'alert',
							tabindex: -1
						} ).text( response.errors[ 0 ] );
						themeCheckout.getSeatsData();
					} else {
						console.info( '[ Reserve seats success ] ', response );

						themeCheckout.updateSeatsView( response.reservations );

						// show Cancel button for Change usage and hide modal
						themeCheckout.$cancelSeatsModal.show();
						themeCheckout.hideSeatsModal();
					}
				},
				error: function ( xhr, status, error ) {
					themeCheckout.getSeatsData();
					themeCheckout.$submitError.attr( 'role', 'alert' ).text( 'There was an error reserving seats, please try again.' );
					console.error( xhr, status, error );
					if ( typeof Raven !== 'undefined' ) {
						Raven.captureMessage( '[ Reserve seats error ] ' + error, {
							level: 'error',
							extra: {
								xhr: xhr,
								status: status
							}
						} );
					}
				},
				complete: function () {
					themeCheckout.$inRequest = false;
					themeCheckout.$checkoutSeatsModal.attr( 'disabled', false );
					themeCheckout.changeTextCheckoutButton( themeCheckout.$selectedSeats );
				}
			} );
		},
		changeReservedSeatTicketType: function ( e ) {
			if ( themeCheckout.$inRequest ) return;

			var selectedTicketType = $( e.target ).val(),
				selectedSeat = $( e.target ).data( 'seat' );

			var donateAmount = 0;
			if ( $( '.donate-amount' ).length ) {
				donateAmount = $( '.donate-amount' ).first().text();
			}
			if ( $( '#donate-me' ).is( ':checked' ) ) {
				themeCheckout.order.donation = donateAmount;
			}

			var data = {
				action: 'nj_change_reserved_seat_ticket_type',
				_ajax_nonce: $( '#nj_checkout_nonce' ).val(),
				order_id: themeCheckout.$reservedOrderId,
				reservations: [
					{
						"showtime_id": themeCheckout.order.showtime,
						"requested_tickets": [
							{
								"seat": selectedSeat,
								"ticket_type": selectedTicketType
							}
						]
					}
				]
			};

			themeCheckout.$inRequest = true;
			themeCheckout.disableForm( 'UPDATING TOTAL...' );

			$.ajax( {
				url: window.ajaxurl || window.themeSettings.ajaxUrl,
				method: 'POST',
				timeout: 60000,
				data: data,
				success: function ( response ) {
					if ( response.success === false ) {
						console.error( '[ Change ticket type error ]', response.data );
						themeCheckout.$submitError.attr( {
							role: 'alert',
							tabindex: -1
						} ).text( response.data[ 0 ] );
						return false;
					}

					if ( response.errors.length ) {
						console.error( '[ Change ticket type error ]', response.errors );
						themeCheckout.$submitError.attr( {
							role: 'alert',
							tabindex: -1
						} ).text( response.errors[ 0 ] );
					} else {
						themeCheckout.updateSeatsView( response.reservations );

						console.info( '[ Change ticket type success ] ', response );
					}
					themeCheckout.applyDiscountCode();
				},
				error: function ( xhr, status, error ) {
					themeCheckout.$submitError.attr( 'role', 'alert' ).text( 'There was an error changing ticket type, please try again.' );

					console.error( xhr, status, error );
					if ( typeof Raven !== 'undefined' ) {
						Raven.captureMessage( '[ Change ticket type  error ] ' + error, {
							level: 'error',
							extra: {
								xhr: xhr,
								status: status
							}
						} );
					}
				},
				complete: function () {
					themeCheckout.$inRequest = false;
					themeCheckout.enableForm();
				}
			} );
		},
		clearSeatsView: function () {
			themeCheckout.$seatTicketTypeSelect.off( 'change' );
			$( '.seat-ticket-type .select-ticket-type' ).not( '.hidden' ).remove();
		},
		getSeatProperties: function ( seatAddress ) {
			if ( jQuery.isEmptyObject( themeCheckout.seatPropertiesCache[ seatAddress ] ) ) {
				var seatMapping = seatAddress.split( "-" ),
					sectionId = parseInt( seatMapping[ 0 ], 10 ) - 1,
					rowId = parseInt( seatMapping[ 1 ], 10 ) - 1,
					seatId = parseInt( seatMapping[ 2 ], 10 ) - 1,
					seat = themeCheckout.$seatsData[ 'sections' ][ sectionId ][ 'rows' ][ rowId ][ 'seats' ][ seatId ],
					seatProperties = {
						seatDisplayId: seat.display_id,
						seatAllowedTicketTypes: seat.data.allowed_ticket_types,
						confirmMessage: seat.confirm_message || false
					};

				themeCheckout.seatPropertiesCache[ seatAddress ] = seatProperties;
			}
			return themeCheckout.seatPropertiesCache[ seatAddress ];
		},
		updateSeatsView: function ( reservations ) {
			themeCheckout.clearSeatsView();
			themeCheckout.$reservedSeats = [];

			$.each( reservations, function ( index, data ) { // backend returns reservations within a single element array
				$.each( data, function ( index, data ) {
					// available properties: 'seat' (ex. "1-2-1"), 'ticket_type' (ex. "general-admission")

					themeCheckout.$reservedSeats.push( data.seat );

					// Find seat display ID.
					var seatProperties = themeCheckout.getSeatProperties( data.seat );

					var seatElement = $( '.seat-ticket-type .select-ticket-type.hidden' ).clone();
					var seatSelect = seatElement.find( '.select-container' ).find( 'select' );

					$.each( seatSelect.find( 'option' ), function ( i, option ) {
						if ( !(seatProperties.seatAllowedTicketTypes.indexOf( $( option ).data( 'ticket_type' ).ID ) > -1) ) {
							$( option ).prop( 'disabled', true );
						}
					} );

					seatSelect.val( data.ticket_type ).data( 'seat', data.seat );

					if ( '_blocked' !== data.ticket_type ) {
						seatElement.find( 'label' ).html( "Seat: <br />" + seatProperties.seatDisplayId );
						seatElement.appendTo( '.seat-ticket-type' ).removeClass( 'hidden' );
					}
				} );
			} );

			// Refresh props and reattach select change handler
			themeCheckout.refreshableProps();
			themeCheckout.$seatTicketTypeSelect.change( themeCheckout.changeReservedSeatTicketType );

			// Update checkout prices
			themeCheckout.toggleActiveCheckoutBySeats();
		},
		attachFauxselect: function () {
			// open the styled select dropdown
			themeUx.$showList.on( 'click', function ( e ) {
				themeUx.openDropdownList( e );
			} );

			// close the styled select dropdown
			themeUx.$document.on( 'click', function ( e ) {
				themeUx.closeDropdownList( e );
			} );

			// select an item in the styled select dropdown
			themeUx.$list.find( 'li' ).click( function ( e ) {
				if ( $( e.target ).hasClass( 'disabled' ) )
					return;
				themeUx.selectDropdownListQuantity( e );
			} );

			// update value of styled select dropdown on native dropdown change event
			themeUx.$styledSelect.change( function ( e ) {
				themeUx.updateDummySelect( e );
			} );

		},
		toggleActiveCheckout: function () {

			themeCheckout.$checkoutContainer.removeClass( 'checkout-active' );

			$.each( themeCheckout.$quantitySelect, function ( i, qtySelect ) {
				if ( parseInt( $( qtySelect ).val(), 10 ) > 0 ) {
					themeCheckout.$checkoutContainer.addClass( 'checkout-active' );
				}
			} );

			themeCheckout.updateQuantity();
		},
		toggleActiveCheckoutBySeats: function () {

			themeCheckout.$checkoutContainer.removeClass( 'checkout-active' );

			if ( themeCheckout.$reservedOrderId ) {
				themeCheckout.$checkoutContainer.addClass( 'checkout-active' );
			}

			themeCheckout.updateQuantityBySeats();
		},
		manageQtysAvailable: function () {

			var $qtyAvailable = $( '#qty-available' )

			// if we're not low on tickets, don't do anything
			if ( !$qtyAvailable.length )
				return;

			var totalQty = 0,
				qtyRemaining,
				qtyAvailable = parseInt( $qtyAvailable.text(), 10 ),
				$dummySelectContainers = $( '.ticket-quantity .dummy-select-container' );

			$.each( themeCheckout.$quantitySelect, function ( i, qtySelect ) {
				totalQty += parseInt( $( qtySelect ).val(), 10 )
			} );

			if ( totalQty > 0 ) {
				$( '.ticket-quantity' ).removeClass( 'no-quantity' );
			}

			qtyRemaining = (qtyAvailable - totalQty);

			// reset all ticket quantities to be enabled
			themeCheckout.$quantitySelect.find( 'option' ).prop( 'disabled', false );
			$dummySelectContainers.find( 'li' ).removeClass( 'disabled' );

			// disable ticket quantities based on how many are left
			$.each( themeCheckout.$quantitySelect, function ( i, qtySelect ) {
				var $qtySelect = $( qtySelect ),
					selectedIndex = $qtySelect.prop( 'selectedIndex' ),
					$qtySelectDummyContainer = $qtySelect.closest( '.select-container' ).next( '.dummy-select-container' ),
					$qtySelectDummy = $qtySelectDummyContainer.find( '.selected-quantity' ),
					maxSelectable = qtyRemaining + selectedIndex;
				$qtySelect.find( 'option:gt(' + (maxSelectable) + ')' ).prop( 'disabled', true );
				$qtySelectDummyContainer.find( 'li:gt(' + (maxSelectable) + ')' ).addClass( 'disabled' );
				$qtySelectDummy.html( selectedIndex );
			} )
		},
		updateQuantity: function () {

			var totalTickets = 0;
			var bookingFee = 0;
			var totalPrice = 0;

			themeCheckout.order.tickets = {};

			$.each( themeCheckout.$quantitySelect, function ( i, qtySelect ) {
				var $qtySelect = $( qtySelect );
				var $qtySelectDummy = $( qtySelect ).closest( '.select-container' ).next( '.dummy-select-container' ).find( '.selected-quantity' );
				var ticketQty = parseInt( $qtySelect.val(), 10 );
				var ticketType = $qtySelect.data( 'ticket_type' );
				var $ticketInfo = $( '.tickets_' + ticketType.name );
				var ticketTypeSubtotal = ticketQty * ticketType.price;

				//update styled dropdown
				$qtySelectDummy.html( ticketQty );

				totalTickets += ticketQty;
				totalPrice += ticketTypeSubtotal;

				if ( ticketType.price > 0 ) {
					bookingFee += ticketQty * BOOKING_FEE;
				}

				themeCheckout.order.tickets[ ticketType.name ] = ticketQty;

				$ticketInfo
					.find( '.quantity' ).text( ticketQty ).end()
					.find( '.subtotal' ).text( (ticketTypeSubtotal).toFixed( 2 ) );

				if ( ticketQty > 0 ) {
					$ticketInfo.addClass( 'active' );
				} else {
					$ticketInfo.removeClass( 'active' );
				}
			} );

			var donateAmount = $( '.donate-amount' ).first().text();

			totalPrice += bookingFee;

			if ( $( '#donate-me' ).is( ':checked' ) ) {
				totalPrice += Number( donateAmount );
				themeCheckout.order.donation = donateAmount;
			} else {
				themeCheckout.order.donation = 0;
			}

			if ( themeCheckout.order.discount ) {
				totalPrice -= themeCheckout.order.discount;
			}

			$( '.booking_fee_total' ).text( bookingFee.toFixed( 2 ) );

			// Maybe subtract the amount the gift card can cover from the overall total.
			if ( 'undefined' !== typeof themeCheckout.order.giftCardTotal) {

				// Before modifying totalPrice, check giftCardTotal against it; if it's > 0 at this point, it means a donation was added or a promo code removed since the gift card was applied. So we need to make sure payment method is gc_partial, not gc.
				if (
					0 !== themeCheckout.order.giftCardTotal &&
					( totalPrice - themeCheckout.order.giftCardTotal ) > 0
				) {
					themeCheckout.paymentMethod = 'gc_partial';
				}

				totalPrice -= themeCheckout.order.giftCardTotal;
			}

			// In some cases like adding/removing discount codes to an order that has some or all of its cost covered by a gift card, totalPrice can be a negative value here. This check ensures the actual total never goes below $0.
			if ( totalPrice < 0 ) {
				totalPrice = 0;
			}

			themeCheckout.order.total = totalPrice;
			themeCheckout.order.originalTotal = totalPrice; // themeCheckout.order.total can be modified by discount codes, gift cards, etc. This original_total value is only modified on ticket quantity changes, and is useful for resetting UI state as discount codes, gift cards, etc. are added and removed.
			themeCheckout.order.bookingFee = bookingFee;

			$( '.total_purchase_price' ).text( totalPrice.toFixed( 2 ) );

			if ( themeCheckout.order.total === 0 && themeCheckout.orderHasTickets() ) {
				themeCheckout.hideCreditCardFields();
			} else {
				themeCheckout.showCreditCardFields();
			}

			// Perform a similar paymentMethod check as above, where if a donation's been added or promo code removed since applying a gift card, we ensure the payment method is gc_partial, not gc.
			if ( 'undefined' !== typeof themeCheckout.order.giftCardTotal ) {
				if (
					0 !== themeCheckout.order.giftCardTotal &&
					( themeCheckout.order.total > themeCheckout.order.giftCardTotal )
				) {
					themeCheckout.paymentMethod = 'gc_partial';
				}
			}
		},
		updateQuantityBySeats: function () {
			var totalTickets = 0;
			var ticketTypesQty = [];
			var bookingFee = 0;
			var totalPrice = 0;

			themeCheckout.order.tickets = {};

			$.each( themeCheckout.$seatTicketTypeSelect, function( i, ticketTypeSelect ) {
				var ticketType = $( 'option:selected', ticketTypeSelect ).data( 'ticket_type' );

				ticketType[ 'qty' ] = ticketTypesQty[ ticketType.name ] ? ticketTypesQty[ ticketType.name ][ 'qty' ] + 1 : 1;
				ticketTypesQty[ ticketType.name ] = ticketType;
			} );

			$( '.tickets_quantity_subtotal' ).removeClass( 'active' );

			for ( var key in ticketTypesQty ) {
				if ( ticketTypesQty.hasOwnProperty( key ) ) {
					var ticketType = ticketTypesQty[ key ];
					var $ticketInfo = $( '.tickets_' + ticketType.name );
					var ticketTypeSubtotal = ticketType.qty * ticketType.price;

					totalTickets += ticketType.qty;
					totalPrice += ticketTypeSubtotal;
					if (ticketType.price > 0) {
						bookingFee += ticketType.qty * BOOKING_FEE;
					}

					themeCheckout.order.tickets[ ticketType.name ] = ticketType.qty;

					$ticketInfo
						.find( '.quantity' ).text( ticketType.qty ).end()
						.find( '.subtotal' ).text( (ticketTypeSubtotal).toFixed( 2 ) );

					if ( ticketType.qty > 0 ) {
						$ticketInfo.addClass( 'active' );
					}
				}
			}

			totalPrice += bookingFee;

			if ( 0 < totalPrice ) {
				themeCheckout.showCreditCardFields();
			} else {
				themeCheckout.hideCreditCardFields();
			}

			var donateAmount = $( '.donate-amount' ).first().text();

			if ( $( '#donate-me' ).is( ':checked' ) ) {
				totalPrice += Number( donateAmount );
				themeCheckout.order.donation = donateAmount;

				// Helps *ensure* card fields are visible if e.g. have chosen a free ticket with no promo codes, but then checked the donation box.
				themeCheckout.showCreditCardFields();
			} else {
				themeCheckout.order.donation = 0;
			}

			if ( themeCheckout.order.discount ) {
				totalPrice -= themeCheckout.order.discount;
			}

			$( '.booking_fee_total' ).text( bookingFee.toFixed( 2 ) );

			// Maybe subtract the amount the gift card can cover from the overall total.
			if ( 'undefined' !== typeof themeCheckout.order.giftCardTotal ) {

				// Before modifying totalPrice, check giftCardTotal against it; if it's > 0 at this point, it means a donation was added or a promo code removed since the gift card was applied. So we need to make sure payment method is gc_partial, not gc.
				if (
					0 !== themeCheckout.order.giftCardTotal &&
					( totalPrice - themeCheckout.order.giftCardTotal ) > 0
				) {
					themeCheckout.paymentMethod = 'gc_partial';
				}

				totalPrice -= themeCheckout.order.giftCardTotal;
			}

			themeCheckout.order.total = totalPrice;
			themeCheckout.order.originalTotal = totalPrice;
			themeCheckout.order.bookingFee = bookingFee;

			$( '.total_purchase_price' ).text( totalPrice.toFixed( 2 ) );
		},
		/**
		 * Applies gift card to order total.
		 *
		 * @return {bool} False on error.
		 */
		applyGiftCard: function() {

			if ( !(themeCheckout.orderHasTickets() || themeCheckout.orderHasPaidTickets()) ) {
				themeCheckout.removeGiftCard();
				themeCheckout.$giftCardError.html( 'Gift Cards not valid for this order' ).css( 'visibility', 'visible' );
				return;
			}

			if ( '' === themeCheckout.$giftCard.val() ) {
				themeCheckout.removeGiftCard();
				return;
			}

			themeCheckout.$checkout.trigger( 'checkout-start-loading' );

			themeCheckout.$giftCardRow.addClass( 'gc-applying' );

			themeCheckout.$giftCardApply.html( 'CHECKING...' );

			var data = {
				action: 'nj_apply_gift_card',
				_ajax_nonce: $( document.getElementById( 'nj_checkout_nonce' ) ).val(),
				pm: themeCheckout.paymentMethod,
				order: $.extend( {}, themeCheckout.order, { email: themeCheckout.$emailInput.val() } ),
				gcAccount: themeCheckout.$giftCard.val(),
				gcCvv: themeCheckout.$giftCardCvv.val()
			};

			$.ajax( {
				url: window.ajaxurl || window.themeSettings.ajaxUrl,
				method: 'POST',
				timeout: 60000,
				data: data,
				success: function ( response ) {
					if ( response.success && response.balanceAmount > 0.00 ) {
						themeCheckout.updateGiftCardAmounts( response.balanceAmount, response.differenceAmount );
						themeCheckout.$giftCardApply.html( 'REMOVE' );
						themeCheckout.$giftCard.prop( 'readonly', true );
						themeCheckout.$giftCardWrap.addClass( 'gc-code-accepted' );
					} else {
						// some error...
						var error = !!response.data ? response.data.toString() : ( !!response.error ? response.error.toString() : 'Unknown Error' );

						themeCheckout.$giftCardError.html( error ).css( 'visibility', 'visible' );
						themeCheckout.makeGiftCardEditable();
					}

					themeCheckout.$checkout.trigger( 'checkout-stop-loading' );
				},
				error: function ( xhr, status, error ) {
					// timeout or server error on our end...
					themeCheckout.$giftCardError.html( 'An error occurred, please try again' ).css( 'visibility', 'visible' );
					themeCheckout.makeGiftCardEditable();

					themeCheckout.$checkout.trigger( 'checkout-stop-loading' );
				}
			} ).done( function() {
				themeCheckout.$giftCardRow.removeClass( 'gc-applying' );
				themeCheckout.$checkout.trigger( 'checkout-stop-loading' );
			} );
		},
		/**
		 * If a gift card's already entered, in some cases we need to remove then reapply that gift card's info so the order totals--especially the portion the gift card will cover--are correct.
		 *
		 * @returns {void}
		 */
		maybeReapplyGiftCard: function() {
			const giftCardAccount = themeCheckout.$giftCard.val();
			const giftCardCvv = themeCheckout.$giftCardCvv.val();

			if ( 'undefined' === typeof giftCardAccount || 'undefined' === typeof giftCardCvv ) {
				return;
			}

			if ( '' === giftCardAccount || '' === giftCardCvv ) {
				return;
			}

			themeCheckout.$checkout.trigger( 'checkout-start-loading' );

			themeCheckout.removeGiftCard();

			// Restore the gift card's account and CVV values so we can reapply the gift card.
			themeCheckout.$giftCard.val( giftCardAccount );
			themeCheckout.$giftCardCvv.val( giftCardCvv );

			themeCheckout.applyGiftCard();
		},
		/**
		 * Preserves gift card field values, but makes them editable again; a useful state to return to after Gift Card ajax errors, for example.
		 */
		makeGiftCardEditable: function() {
			themeCheckout.$giftCard.prop( 'readonly', false );
			themeCheckout.$giftCardCvv.prop( 'readonly', false );
			themeCheckout.$giftCardApply.html( 'APPLY' );
			themeCheckout.$giftCardRow.removeClass( 'gc-applying' );
			themeCheckout.$giftCardWrap.removeClass( 'gc-code-accepted' );
		},
		/**
		 * Clears gift card fields.
		 */
		removeGiftCard: function() {
			themeCheckout.$giftCard.prop( 'readonly', false ).val( '' );
			themeCheckout.$giftCardCvv.prop( 'readonly', false ).val( '' );
			themeCheckout.$giftCardApply.html( 'APPLY' );
			themeCheckout.$giftCardWrap.removeClass( 'gc-code-accepted' );

			themeCheckout.updateGiftCardAmounts( 0, themeCheckout.order.originalTotal );
			themeCheckout.paymentMethod = 'cc';
		},
		/**
		 * Updates checkout fields to incorporate gift card.
		 *
		 * @param {float} balanceAmount Gift card balance.
		 * @param {float} differenceAmount Difference between the order total and gift card balance, 0 when gift card can cover whole order.
		 */
		updateGiftCardAmounts: function( balanceAmount, differenceAmount ) {
			balanceAmount = parseFloat( balanceAmount, 10 );
			differenceAmount = parseFloat( differenceAmount, 10 );

			// The gift card can pay for the whole order.
			if ( 0 === differenceAmount ) {
				themeCheckout.order.giftCardTotal = themeCheckout.order.total;
				themeCheckout.order.total = 0;
				themeCheckout.paymentMethod = 'gc';

				themeCheckout.$giftCardTotal.find( '.gift_card_amount' ).text( themeCheckout.order.giftCardTotal.toFixed( 2 ) );

				$( '.total_purchase_price' ).text( themeCheckout.order.total.toFixed( 2 ) );
			} else {
				themeCheckout.order.giftCardTotal = balanceAmount;
				themeCheckout.order.total = differenceAmount;
				themeCheckout.paymentMethod = 'gc_partial';

				themeCheckout.$giftCardTotal.find( '.gift_card_amount' ).text( themeCheckout.order.giftCardTotal.toFixed( 2 ) );

				$( '.total_purchase_price' ).text( themeCheckout.order.total.toFixed( 2 ) );
			}

			if ( jQuery.isEmptyObject( themeCheckout.$seatsData ) ) {
				themeCheckout.updateQuantity();
			} else {
				themeCheckout.updateQuantityBySeats();
			}

			if ( balanceAmount > 0 ) {
				themeCheckout.$giftCardTotal.show();
			} else {
				themeCheckout.$giftCardTotal.hide();
			}

			if ( 0 === themeCheckout.order.total && themeCheckout.orderHasTickets() ) {
				themeCheckout.hideCreditCardFields();
			} else {
				themeCheckout.showCreditCardFields();
			}
		},
		applyDiscountCode: function () {
			if ( !( themeCheckout.orderHasTickets() || themeCheckout.orderHasPaidTickets() ) ) {
				themeCheckout.removeDiscountCode();
				themeCheckout.$discountCodeError.html( 'Discounts not valid for this order' ).css( 'visibility', 'visible' );
				return false;
			}

			if ( themeCheckout.$discountCode.val() !== '' ) {

				themeCheckout.$checkout.trigger( 'checkout-start-loading' );

				themeCheckout.$discountCodeApply.html( 'CHECKING...' );

				var data = {
					action: 'nj_apply_discount_code',
					_ajax_nonce: $( '#nj_checkout_nonce' ).val(),
					pm: themeCheckout.paymentMethod,
					address: {
						first_name: $( '#first_name' ).val(),
						last_name: $( '#last_name' ).val(),
						billing_address: $( '#billing_address' ).val(),
						country: $( '#country' ).val(),
						postal_code: $( '#postal_code' ).val(),
						dnd: themeCheckout.$dndCheckbox.is( ':checked' ),
					},
					order: $.extend( {}, themeCheckout.order, { email: themeCheckout.$emailInput.val() } ),
					discount_code: themeCheckout.$discountCode.val()
				};

				$.ajax( {
					url: window.ajaxurl || window.themeSettings.ajaxUrl,
					method: 'POST',
					timeout: 60000,
					data: data,
					success: function ( response ) {
						if ( response.success && response.discountAmount >= 0 ) {
							themeCheckout.updateDiscounts( response.discountAmount );
							themeCheckout.$discountCodeApply.html( 'REMOVE' );
							themeCheckout.$discountCode.prop( 'readonly', true );
						} else {
							// some error...
							var error = !!response.error ? response.error.toString() : 'Unknown Error';
							themeCheckout.$discountCodeError.html( error ).css( 'visibility', 'visible' );
							themeCheckout.removeDiscountCode();
						}

						themeCheckout.$checkout.trigger( 'checkout-stop-loading' );

					},
					error: function ( xhr, status, error ) {
						// timeout or server error on our end...
						themeCheckout.$discountCodeError.html( 'An error occurred, please try again' ).css( 'visibility', 'visible' );
						themeCheckout.removeDiscountCode();
						themeCheckout.$checkout.trigger( 'checkout-stop-loading' );
					}
				} ).done( function() {
					themeCheckout.maybeReapplyGiftCard();
				} );

				return false;
			}
		},
		removeDiscountCode: function () {
			themeCheckout.$checkout.trigger( 'checkout-start-loading' );

			themeCheckout.$discountCode.prop( 'readonly', false );
			themeCheckout.$discountCode.val( '' );
			themeCheckout.updateDiscounts( '0' );
			themeCheckout.$discountCodeApply.html( 'APPLY' );

			themeCheckout.$checkout.trigger( 'checkout-stop-loading' );

			themeCheckout.maybeReapplyGiftCard();
			return false;
		},
		updateDiscounts: function ( discountAmount ) {

			discountAmount = parseFloat( discountAmount, 10 );
			themeCheckout.order.discount = 0;

			if ( jQuery.isEmptyObject( themeCheckout.$seatsData ) ) {
				themeCheckout.updateQuantity();
			} else {
				themeCheckout.updateQuantityBySeats();
			}

			themeCheckout.order.total = themeCheckout.order.total - discountAmount;

			if ( themeCheckout.order.total < 0 )
			{
				themeCheckout.order.total = 0;
			}

			themeCheckout.order.discount = discountAmount;

			themeCheckout.$discount.find( '.discount_amount' ).text( discountAmount.toFixed( 2 ) );

			$( '.total_purchase_price' ).text( themeCheckout.order.total.toFixed( 2 ) );

			if ( discountAmount > 0 ) {
				themeCheckout.$discount.show();
			} else {
				themeCheckout.$discount.hide();
			}

			if ( themeCheckout.order.total === 0 && themeCheckout.orderHasTickets() ) {
				themeCheckout.hideCreditCardFields();

				// If a promo code has been entered that equals the cost of the order, remove the gift card and just use the 100% promo code.
				if ( 'undefined' !== typeof themeCheckout.order.giftCardTotal ) {
					if ( themeCheckout.order.discount >= ( themeCheckout.order.originalTotal + themeCheckout.order.giftCardTotal ) ) {
						themeCheckout.removeGiftCard();
						$( '.gift-card-row' ).slideUp();
					}
				} else {
					// If a gift card hasn't been entered yet, still hide the gift card fields in the case of a 100% promo.
					if ( themeCheckout.order.discount >= themeCheckout.order.originalTotal ) {
						themeCheckout.removeGiftCard();
						$( '.gift-card-row' ).slideUp();
					}
				}
			} else {
				themeCheckout.showCreditCardFields();
				$( '.gift-card-row' ).slideDown();
			}
		},
		showCreditCardFields: function() {
			themeCheckout.$ccFields.slideDown();
		},
		hideCreditCardFields: function() {
			themeCheckout.$ccFields.slideUp();
		},
		applyMembershipCosts: function () {
			themeCheckout.order.membership = themeCheckout.$membershipCost[ 'annual' ][ 'single' ];
			themeCheckout.order.membership_plan = {
				'title': themeCheckout.$membershipCost[ 'plan' ],
				'id': themeCheckout.$membershipCost[ 'id' ],
				'selected': 'single'
			};

			themeCheckout.order.total = themeCheckout.order.membership;
		},
		applyTicketPackCosts: function () {
			var ticketPackCost = themeCheckout.$ticketPackValue[ 'cost' ];

			themeCheckout.order.ticket_pack = {
				'title': themeCheckout.$ticketPackValue[ 'offer' ],
				'id': themeCheckout.$ticketPackValue[ 'id' ],
				'cost': ticketPackCost
			};

			themeCheckout.order.total = ticketPackCost;
		},
		validateInputs: function ( item ) {
			var val = item.val();
			if ( item.hasClass( 'required' ) ) {
				item.toggleClass( 'error', $.trim( val ) === '' || val === null );
			}
		},
		validateTermsCheckbox: function () {
			var checked = $( 'input[name=terms]' ).prop( 'checked' );
			themeCheckout.$terms.toggleClass( 'error', checked !== true );
		},
		isValidEmailAddress: function ( emailAddress ) {
			var pattern = new RegExp( /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/ );
			return pattern.test( emailAddress );
		},
		checkEmailInput: function () {
			var emailAddress = themeCheckout.$emailInput.val();
			if ( !themeCheckout.isValidEmailAddress( emailAddress ) ) {
				themeCheckout.$emailInput.addClass( 'error' );
			} else {
				themeCheckout.$emailInput.removeClass( 'error' );
			}
		},
		isValidPhoneNumber: function ( phoneNumber ) {
			var pattern = /\d/g;
			return phoneNumber.match( pattern ) !== null && phoneNumber.match( pattern ).length === 10;
		},
		validatePhoneNumber: function () {
			if ( !themeCheckout.$dndCheckbox.is( ':checked' ) )
				return;
			var phoneNumber = themeCheckout.$phone.val();
			if ( !themeCheckout.isValidPhoneNumber( phoneNumber ) ) {
				themeCheckout.$phone.addClass( 'error' );
			}
		},
		isValidPercent: function ( percent ) {
			var pattern = /\d/g;
			return percent.match( pattern ) !== null && percent.match( pattern ).length < 3;
		},
		validateTipPercent: function () {
			if ( !themeCheckout.$dndCheckbox.is( ':checked' ) )
				return;
			var percent = themeCheckout.$tipPercent.val();
			if ( !themeCheckout.isValidPercent( percent ) ) {
				themeCheckout.$tipPercent.addClass( 'error' );
				themeCheckout.$dndStep2.find( '.error-message' ).css( 'visibility', 'visible' );
			} else {
				themeCheckout.$tipPercent.removeClass( 'error' );
				themeCheckout.$dndStep2.find( '.error-message' ).css( 'visibility', 'hidden' );
			}
		},
		validateForm: function ( e ) {

			e.preventDefault();

			themeCheckout.$fields.each( function () {
				themeCheckout.validateInputs( $( this ) );
			} );

			themeCheckout.checkEmailInput();

			if ( themeCheckout.$terms.length ) {
				themeCheckout.validateTermsCheckbox();
			}

			if ( $( '.error' ).length ) {
				return false;
			}

			themeCheckout.$checkout.find( '*' ).filter( '.payment-input-container.active *' ).blur();
			themeCheckout.$fields.blur();

			// if it's a free or cash order, skip the token and submit the checkout
			// if the payment method is gift card, we just submit
			// credit cards are handled separately by the token callback
			if ( (themeCheckout.order.total === 0 && themeCheckout.orderHasTickets()) || themeCheckout.paymentMethod === 'cash' ) {
				themeCheckout.submitCheckout();
			} else if ( themeCheckout.paymentMethod === 'gc' ) {
				themeCheckout.submitCheckout();
			} else if ( themeCheckout.paymentMethod === 'cc' || themeCheckout.paymentMethod === 'gc_partial' ) {
				themeCheckout.requestToken();
			}
			return true;
		},
		disableForm: function ( buttonLabel ) {
			// this completely disabled the form to prevent multiple submissions

			themeCheckout.$checkoutContainer.addClass( 'processing-payment' );
			themeCheckout.$submitButton.prop( 'disabled', true ).prop( 'value', !buttonLabel ? 'PLEASE WAIT...' : buttonLabel );
			themeCheckout.$form.get( 0 ).onsubmit = function ( e ) {
				e.preventDefault();
				e.stopPropagation();
				return false;
			};
			themeCheckout.$submitError.text( '' );

		},
		enableForm: function ( message ) {
			// this re-enables the form in the case of a card declined or other submission issue
			themeCheckout.$checkoutContainer.removeClass( 'processing-payment' );

			message = !message ? '' : $.type( message ) === 'string' ? message : 'Unknown Error';
			themeCheckout.$submitError.attr( 'role', 'alert' ).text( {
				'Failed to create token': 'Please ensure your credit card number is entered correctly.'
			}[ message ] || message );
			themeCheckout.$form.get( 0 ).onsubmit = function ( e ) {
			};
			var buttonText = themeUx.$body.hasClass( 'page-template-donate-template' ) ? 'DONATE' : 'PURCHASE';
			themeCheckout.$submitButton.prop( 'disabled', false ).prop( 'value', buttonText );

		},
		initStripeElements: function () {
			var color = $( '.payment-info' ).css( 'color' ),
				accentColor = $( '.accent-color' ).css( 'color' );
			themeCheckout.stripe = Stripe( STRIPE_PUBLIC_KEY );
			var elements = themeCheckout.stripe.elements();

			// Floating labels
			var inputs = $( '#credit-card-inputs .input' ).get();
			Array.prototype.forEach.call( inputs, function ( input ) {
				input.addEventListener( 'focus', function () {
					input.classList.add( 'focused' );
				} );
				input.addEventListener( 'blur', function () {
					input.classList.remove( 'focused' );
				} );
				input.addEventListener( 'keyup', function () {
					if ( input.value.length === 0 ) {
						input.classList.add( 'empty' );
					} else {
						input.classList.remove( 'empty' );
					}
				} );
			} );

			var elementStyles = {
				base: {
					color: color,
					fontWeight: 500,
					fontFamily: 'Verdana, Helvetica, Verdana, sans-serif',
					fontSize: '16px',
					fontSmoothing: 'antialiased',

					'::placeholder': {
						color: accentColor,
					},
					':-webkit-autofill': {
						color: accentColor,
					},
				},
				invalid: {
					color: 'red',

					'::placeholder': {
						color: accentColor,
					},
				},
			};

			var elementClasses = {
				focus: 'focused',
				empty: 'empty',
				invalid: 'invalid',
			};

			themeCheckout.cardNumber = elements.create( 'cardNumber', {
				style: elementStyles,
				classes: elementClasses,
			} );
			themeCheckout.cardNumber.mount( '#stripe-card-number' );

			var cardExpiry = elements.create( 'cardExpiry', {
				style: elementStyles,
				classes: elementClasses,
			} );
			cardExpiry.mount( '#stripe-card-expiry' );

			var cardCvc = elements.create( 'cardCvc', {
				style: elementStyles,
				classes: elementClasses,
			} );
			cardCvc.mount( '#stripe-card-cvc' );

		},
		requestToken: function () {
			if ( typeof STRIPE_PUBLIC_KEY !== 'undefined' && !!STRIPE_PUBLIC_KEY ) {
				var additionalData = {
					address_zip: $( '#postal_code' ).val()
				};

				themeCheckout.stripe.createToken( themeCheckout.cardNumber, additionalData ).then( function ( result ) {
					if ( typeof result.error !== 'undefined' && result.error ) {
						themeCheckout.enableForm( result.error.message );
						themeUx.$document.trigger( 'checkout-error', { type: 'stripe-token', details: result.Error } );
					} else if ( ! themeCheckout.checkoutSubmitted ) {
						themeCheckout.submitCheckout( result.token );
					}
				} );
			}
		},
		submitCheckout: function ( tokenData ) {
			themeCheckout.checkoutSubmitted = true;

			var data = {
				action: 'nj_checkout',
				_ajax_nonce: $( '#nj_checkout_nonce' ).val(),
				pm: themeCheckout.paymentMethod,
				address: {
					first_name: $( '#first_name' ).val(),
					last_name: $( '#last_name' ).val(),
					postal_code: $( '#postal_code' ).val()
				},
				order: $.extend( {}, themeCheckout.order, { email: themeCheckout.$emailInput.val() } ),
				discount_code: themeCheckout.$discountCode.val()
			};

			if ( themeCheckout.$membershipSignup.length ) {
				data = themeMembership.getMemberData( data );
			}

			if ( themeCheckout.$seatsData && ! jQuery.isEmptyObject( themeCheckout.$seatsData ) ) {
				data[ 'action' ] = 'nj_finalize_reserved_seats';
				data[ 'order_id' ] = themeCheckout.$reservedOrderId;
			}

			if ( themeCheckout.$donationAmount.length ) {
				data.address.billing_address = $( '#billing_address' ).val();
				data.address.billing_address_2 = $( '#billing_address_2' ).val();
				data.address.city = $( '#city' ).val();
				data.address.state = $( '#state' ).val();
				data.address.country = $( '#country' ).val();
				data.address.postal_code = $( '#postal_code' ).val();
				data.order.total = data.order.total + data.order.donation;
			}

			if ( themeCheckout.$dndCheckbox.is( ':checked' ) ) {
				data.dnd = {};
				if ( themeCheckout.$tipPercent.val() !== '' ) {
					data.dnd.tip_percent = themeCheckout.$tipPercent.val();
				} else if ( themeCheckout.$phone.val() !== '' ) {
					data.dnd.phone = themeCheckout.$phone.val();
				}
			}

			if ( themeCheckout.paymentMethod === 'cc' ) {
				data.tokenData = tokenData;
			} else if ( themeCheckout.paymentMethod === 'gc' ) {
				data.gcAccount = themeCheckout.$gcInput.val().replace( /\s/g, '' );
				data.gcCvv = themeCheckout.$gcCvvInput.val();
			}

			if ( themeCheckout.paymentMethod === 'gc_partial' ) {
				data.tokenData = tokenData;
				data.gcAccount = themeCheckout.$gcInput.val().replace( /\s/g, '' );
				data.gcCvv = themeCheckout.$gcCvvInput.val();
			}

			if ( $( '#grecaptcha-response' ).length > 0 ) {
				data.grecaptchaResponse = $( '#grecaptcha-response' ).val();
			}

			$.ajax( {
				url: window.ajaxurl || window.themeSettings.ajaxUrl,
				method: 'POST',
				timeout: 60000,
				data: data,
				success: function ( response ) {
					themeCheckout.checkoutSubmitted = false;
					if ( response.success && response.orderDetails ) {
						themeCheckout.orderSuccess( response.orderDetails );
						$( document ).trigger( 'checkout-success', { type: 'success', details: response.orderDetails } );
					} else {
						// some error...
						var error = !!response.data ? response.data.toString() : 'Unknown Error';
						themeCheckout.enableForm( error );
						$( document ).trigger( 'checkout-error', { type: 'error', details: error } );
						console.error( '[ Checkout error ] ' + error, response );
						if ( typeof Raven !== 'undefined' ) {
							Raven.captureMessage( '[ Checkout error ] ' + error, {
								level: 'error',
								extra: {
									response: response
								}
							} );
						}
					}
				},
				error: function ( xhr, status, error ) {
					// timeout or server error on our end... don't re-enable the form, just message it
					// as we can't actually say if the charge went through or not.
					themeCheckout.checkoutSubmitted = false;
					themeCheckout.$submitError.attr( 'role', 'alert' ).text( 'There was an error completing your transaction, please contact us for support.' );
					var buttonText = themeUx.$body.hasClass( 'page-template-donate-template' ) ? 'DONATION FAILED' : 'ORDER FAILED';
					themeCheckout.$submitButton.prop( 'value', buttonText );
					$( document ).trigger( 'checkout-error', { type: 'error', details: error } );
					console.error( xhr, status, error );
					if ( typeof Raven !== 'undefined' ) {
						Raven.captureMessage( '[ Checkout error ] ' + error, {
							level: 'error',
							extra: {
								xhr: xhr,
								status: status
							}
						} );
					}
				}
			} );
			return false;
		},
		orderSuccess: function ( orderDetails ) {

			var $ticketsRow = themeCheckout.$orderConfirmation.find( '.tickets_quantity_subtotal' ).remove();
			var $orderData = themeCheckout.$orderConfirmation.find( '.order-data' );

			$( '#order-id' ).text( orderDetails.orderId );
			$( '.order-email' ).text( orderDetails.customerEmail );

			$.each( orderDetails.totals.items, function ( i, item ) {
				$ticketsRow.clone().find( 'span' ).html( item.html_description ).appendTo( $orderData.find( '.tickets .data' ) );
			} );

			$orderData.find( '.booking_fee_total' ).text( orderDetails.totals.booking_fees.toFixed( 2 ) );
			$orderData.find( '.total_purchase_price' ).text( orderDetails.totals.total.toFixed( 2 ) );

			themeCheckout.stopTimer();

			$( '.dnd-pickup-instructions' ).hide();

			themeCheckout.$checkout.hide();
			themeCheckout.$membershipSignup.hide();
			themeCheckout.$orderConfirmation.show();
			themeCheckout.$ticketPackPurchase.hide();

			if ( themeCheckout.$dndCheckbox.is( ':checked' ) ) {
				$( '.dnd-pickup-instructions' ).show();
			}

			$( 'html, body' ).animate( {
				scrollTop: 0
			}, 500 );
		},
		scrollUp: function () {
			if ( themeCheckout.$isMobile.matches ) {
				$( 'html, body' ).animate( {
					scrollTop: 0
				}, 500 );
			}
		},
		orderHasTickets: function () {
			for ( var ticketType in themeCheckout.order.tickets ) {
				if ( themeCheckout.order.tickets[ ticketType ] > 0 )
					return true;
			}
			return false;
		},
		orderHasPaidTickets: function () {
			var hasPaidTickets = false;
			$.each( themeCheckout.$seatTicketTypeSelect, function( i, ticketTypeSelect ) {
				var ticketType = $( 'option:selected', ticketTypeSelect ).data( 'ticket_type' );
				if (ticketType.price > 0) {
					hasPaidTickets = true;
					return;
				}
			});
			return hasPaidTickets;
		},
		getShortSeatMapList: function() {
			var seatsData = themeCheckout.$hall;
			$.each( seatsData.sections, function ( index, section ) {
				if ( section ) {
					$.each( section.rows, function ( index, rows ) {
						if ( rows ) {
							$.each( rows.seats, function ( index, seatsList ) {
								if ( seatsList[ 'display_id' ] ) {
									themeCheckout.$shortSeatsList.push( {
										display_id: seatsList[ 'display_id' ],
										seat_address: seatsList[ 'seat_address' ]
									} );
								}
							})
						}
					})
				}
			});
			return themeCheckout.$shortSeatsList;
		},
		changeTextCheckoutButton: function ( items ) {
			var reservedSeatsMapped = [],
				reservedSeats = '';
			function getNameSeat ( seat ) {
					return themeCheckout.$shortSeatsList.find( displayId => displayId.seat_address === seat ).display_id;
			}
			$.each( items, function ( index, item ) {
				var newSeat = getNameSeat( item );
				reservedSeatsMapped.push( newSeat );
			});
			if ( !themeCheckout.ADAMode && items.length ) {
				reservedSeats = reservedSeatsMapped.join( ', ' );
				themeCheckout.$checkoutSeatsModal.attr( 'disabled', false ).text( "Reserve Seats: " + reservedSeats );
			} else {
				themeCheckout.$checkoutSeatsModal.attr( 'disabled', 'disable' ).text( "Checkout" );
			}
		}
	};
})( jQuery );
